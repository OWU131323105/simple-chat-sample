<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="-1" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚¹ãƒãƒ›ã§ãƒ¯ãƒ‹ãŸãŸãï¼</title>

  <script type="module">
    import { io } from "https://cdn.socket.io/4.5.1/socket.io.esm.min.js";

    document.addEventListener("DOMContentLoaded", () => {
      // å„ãƒ‡ãƒã‚¤ã‚¹ã«å›ºæœ‰ã®IDã‚’ä»˜ä¸
      let devid = sessionStorage.getItem('clientId');
      if (!devid) {
        devid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem('clientId', devid);
      }

      let decPlaces = 2;
      let interval = 50; // ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿é€ä¿¡é–“éš” (20fps)
      let alpha = 0, beta = 0, gamma = 0, z = 0;

      // åŠ é€Ÿåº¦ã«ã‚ˆã‚‹å©ãæ¤œå‡ºç”¨ã®å¤‰æ•°
      let last_z = 0;
      let current_z = 0;
      const TAP_THRESHOLD = 5.0;    // å©ãæ¤œå‡ºã®é–¾å€¤
      const SMASH_INTERVAL = 300;   // é€£ç¶šé€ä¿¡ã‚’é˜²ãé–“éš” (ms)
      let isSmashing = false;       // é€£ç¶šå©ãé˜²æ­¢ãƒ•ãƒ©ã‚°

      const socket = io();

      document.querySelector("#contents").textContent =
        "æ¥ç¶šã•ã‚Œã¾ã—ãŸã€‚ã‚ãªãŸã®IDã¯ï¼š" + devid;
      document.querySelector("#content").style.backgroundColor =
        getColorFromId(devid);

      if (!("WebSocket" in window)) {
        alert("ãƒ–ãƒ©ã‚¦ã‚¶ãŒWebSocketsã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“");
      }

      // æ¥ç¶šãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
      document.querySelector("#connect").addEventListener("click", () => {

        // 1. å‚¾ãæƒ…å ±ã‚’å®šæœŸçš„ã«é€ä¿¡
        setInterval(() => {
          socket.emit("sensor", { id: devid, a: alpha, b: beta, g: gamma, z: z });
        }, interval);

        // 2. åŠ é€Ÿåº¦ã«ã‚ˆã‚‹å©ãæ¤œå‡ºå‡¦ç†
        setInterval(() => {
          current_z = parseFloat(z);
          const z_diff = current_z - last_z;

          if (z_diff < -TAP_THRESHOLD && !isSmashing) {
            console.log("Smash detected! Z-diff:", z_diff.toFixed(2));
            isSmashing = true;
            socket.emit("smash", { id: devid });

            // ä¸€å®šæ™‚é–“å©ãæ¤œå‡ºã‚’ç„¡åŠ¹åŒ–
            setTimeout(() => {
              isSmashing = false;
            }, SMASH_INTERVAL);
          }
          last_z = current_z;
        }, interval);

        document.querySelector("#connect").style.display = "none";
        request_permission();
      });

      // å„ãƒ‡ãƒã‚¤ã‚¹ã«å›ºæœ‰ã®è‰²ã‚’å‰²ã‚Šå½“ã¦
      function getColorFromId(id) {
        let hash = 0;
        for (let i = 0; i < id.length; i++) {
          hash = id.charCodeAt(i) + ((hash << 5) - hash);
        }
        const h = Math.abs(hash % 360);
        return `hsl(${h}, 60%, 65%)`;
      }

      // åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼å€¤ã®å–å¾—
      window.ondevicemotion = (event) => {
        z = event.accelerationIncludingGravity.z.toFixed(decPlaces);
      };

      // å‚¾ãã‚»ãƒ³ã‚µãƒ¼å€¤ã®å–å¾—
      window.ondeviceorientation = (event) => {
        alpha = event.alpha.toFixed(decPlaces);
        beta = event.beta.toFixed(decPlaces);
        gamma = event.gamma.toFixed(decPlaces);
      };

      // iOSå‘ã‘ã‚»ãƒ³ã‚µãƒ¼åˆ©ç”¨è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      function request_permission() {
        if (DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === "function") {
          DeviceMotionEvent.requestPermission();
        }
        if (DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === "function") {
          DeviceOrientationEvent.requestPermission();
        }
      }
    });
  </script>

  <style>
    body {
      min-height: 100vh;
      margin: 0;
      font-family: sans-serif;
      text-align: center;
    }

    #connect {
      width: 15%;
      height: 24px;
    }

    #content {
      background-color: #ccc;
    }

    .space {
      height: 24px;
    }

    /* èª¬æ˜æ–‡ã®æ ã‚¹ã‚¿ã‚¤ãƒ« */
    #game-info {
      width: 80%;
      max-width: 400px;
      text-align: left;
      margin: 20px auto;
      padding: 10px;
      border: 1px solid #aaa;
      background-color: #eee;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <center>
    <h2>å‚¾ã‘ã¦ç‹™ãˆï¼<br>ğŸŠã‚¹ãƒãƒ›ã§ãƒ¯ãƒ‹ãŸãŸãï¼ğŸŠ</h2>

    <div id="game-info">
      <h3>ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«</h3>
      <ul>
        <li>åˆ¶é™æ™‚é–“30ç§’ã§ã€ç©´ã‹ã‚‰å‡ºã¦ãã‚‹ãƒ¯ãƒ‹ã‚’ãƒãƒ³ãƒãƒ¼ã§å©ãã¾ã—ã‚‡ã†ã€‚</li>
        <li>æ™‚é–“çµŒéã¨ã¨ã‚‚ã«ãƒ¯ãƒ‹ã®å‡ºç¾é€Ÿåº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚</li>
      </ul>
      <h3>æ“ä½œæ–¹æ³•</h3>
      <ul>
        <li>é–‹å§‹å§¿å‹¢: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚’åœ°é¢ã¨æ°´å¹³ã«ã€ç”»é¢ãŒå¤©äº•ã‚’å‘ãã‚ˆã†ã«æŒã¡ã¾ã™ã€‚</li>
        <li>ç§»å‹•: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚’å·¦å³ã«å‚¾ã‘ã¦ãƒãƒ³ãƒãƒ¼ã‚’å‹•ã‹ã—ã¾ã™ã€‚</li>
        <li>å©ã: ã‚¹ãƒãƒ›ã®ä¸Šéƒ¨ã‚’ä¸‹ã«ç´ æ—©ãæŒ¯ã‚Šä¸‹ã‚ã™å‹•ä½œã§å©ãã¾ã™ã€‚</li>
      </ul>
    </div>

    <div id="content">
      <div class="space"></div>
      <input id="connect" type="button" value="æ¥ç¶š" />
      <div>
        <div class="space"></div>
        <p id="contents">ãƒ‡ãƒã‚¤ã‚¹ã‚’å‚¾ã‘ã¦ä¸‹ã•ã„</p>
      </div>
    </div>

    <div id="footer">
      <h4>ã‚¹ãƒãƒ›ã‚»ãƒ³ã‚µãƒ¼</h4>
    </div>
  </center>
</body>
</html>